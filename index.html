<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙˆØµÙŠÙ„Ùˆ PRO | Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #6B2E82; --secondary: #FF6B35; --success: #27AE60; --danger: #EB5757; --bg: #f4f7f6; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; display: flex; overflow-x: hidden; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ (Welcome Overlay) */
        #welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 26, 0.98); /* Ù„ÙˆÙ† Ø¯Ø§ÙƒÙ† ÙØ®Ù… */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        .welcome-card {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            border-top: 8px solid var(--secondary);
            animation: slideUp 0.6s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .welcome-card i { font-size: 60px; color: var(--primary); margin-bottom: 20px; }
        .welcome-card h2 { color: #1a1a1a; margin-bottom: 10px; font-weight: 800; }
        .welcome-card p { color: #666; margin-bottom: 30px; line-height: 1.6; }
        
        .btn-enter {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 50px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Cairo';
            transition: 0.3s;
            box-shadow: 0 10px 20px rgba(107, 46, 130, 0.3);
        }
        .btn-enter:hover { background: var(--secondary); transform: scale(1.05); }

        /* Sidebar */
        .sidebar { width: 260px; background: #1a1a1a; color: white; height: 100vh; position: fixed; padding: 20px; box-sizing: border-box; z-index: 1000; }
        .nav-item { padding: 12px 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #ccc; text-decoration: none; margin-bottom: 5px; transition: 0.3s; font-size: 14px; }
        .nav-item:hover, .nav-item.active { background: var(--primary); color: white; }

        .main { margin-right: 260px; width: calc(100% - 260px); padding: 40px; box-sizing: border-box; }
        
        /* Stats & Grid */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-right: 5px solid transparent; }
        .stat-card h2 { margin: 10px 0 0 0; font-size: 24px; font-weight: 800; }
        .stat-card small { color: #888; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        
        .table-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: right; color: #666; border-bottom: 2px solid #eee; padding: 12px; }
        td { padding: 15px; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .badge-success { background: #e8f5e9; color: var(--success); }
        .badge-danger { background: #ffebee; color: var(--danger); }
        .badge-ongoing { background: #fff8e1; color: #f2994a; }
        
        .btn-refresh { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: 'Cairo'; }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <div class="welcome-card">
            <i class="fas fa-user-shield"></i>
            <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ Ø£ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
            <p>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ØªØ·Ø¨ÙŠÙ‚ <b>ØªÙˆØµÙŠÙ„Ùˆ PRO</b>. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø­Ù„Ø§ØªØŒ ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.</p>
            <button class="btn-enter" onclick="hideWelcome()">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <div class="sidebar">
        <h2 style="color: var(--secondary); text-align: center; margin-bottom: 30px;">ØªÙˆØµÙŠÙ„Ùˆ ğŸ›µ</h2>
        <a href="index.html" class="nav-item active"><i class="fas fa-chart-line"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</a>
        <a href="users_admin.html" class="nav-item"><i class="fas fa-user-friends"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†</a>
        <a href="drivers_admin.html" class="nav-item"><i class="fas fa-id-card"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</a>
        <a href="users.html" class="nav-item"><i class="fas fa-users-cog"></i> Ø§Ù„ÙƒÙ„ (Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆÙ…ÙˆØ§Ø·Ù†ÙŠÙ†)</a>
        <a href="requests.html" class="nav-item"><i class="fas fa-user-plus"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>
        <a href="trips.html" class="nav-item"><i class="fas fa-route"></i> Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</a>
        <a href="audit.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i> Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ</a>
        <a href="report.html" class="nav-item"><i class="fas fa-route"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± </a>
        <a href="complaints.html" class="nav-item"><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
        <a href="settings.html" class="nav-item"><i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</a>
    </div>

    <div class="main">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div>
                <h1 style="margin:0">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ù„Ù„Ù†Ø¸Ø§Ù… ğŸ“ˆ</h1>
                <p style="color:#777; margin:5px 0 0 0">Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ØµØ©</p>
            </div>
            <button class="btn-refresh" onclick="fetchAnalytics()">
                <i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
        </header>

        <div class="grid">
            <div class="stat-card" style="border-right-color: var(--primary)">
                <small><i class="fas fa-shopping-basket"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</small>
                <h2 id="total-trips">0</h2>
            </div>
            <div class="stat-card" style="border-right-color: var(--success)">
                <small><i class="fas fa-check-double"></i> Ø±Ø­Ù„Ø§Øª Ù…ÙƒØªÙ…Ù„Ø©</small>
                <h2 id="completed-trips" style="color: var(--success);">0</h2>
            </div>
            <div class="stat-card" style="border-right-color: var(--secondary)">
                <small><i class="fas fa-spinner"></i> Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù…</small>
                <h2 id="ongoing-trips" style="color: var(--secondary);">0</h2>
            </div>
            <div class="stat-card" style="border-right-color: var(--danger)">
                <small><i class="fas fa-ban"></i> Ø±Ø­Ù„Ø§Øª Ù…Ù„ØºØ§Ø©</small>
                <h2 id="cancelled-trips" style="color: var(--danger);">0</h2>
            </div>
        </div>

        <div class="grid">
            <div class="stat-card">
                <small><i class="fas fa-users"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</small>
                <h2 id="total-users">0</h2>
            </div>
            <div class="stat-card" style="background: var(--primary); color: white;">
                <small style="color: #ccc;"><i class="fas fa-wallet"></i> ØµØ§ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</small>
                <h2 id="total-revenue">0 Ø±.Ø³</h2>
            </div>
        </div>

        <div class="table-card">
            <h3>Ø£Ø­Ø¯Ø« Ø§Ù„Ø±Ø­Ù„Ø§Øª</h3>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø±Ù‚Ù…</th>
                        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                        <th>Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                        <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                    </tr>
                </thead>
                <tbody id="activity-table">
                    <tr><td colspan="6" style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
        function hideWelcome() {
            const welcomeScreen = document.getElementById('welcome-screen');
            welcomeScreen.style.opacity = '0';
            setTimeout(() => {
                welcomeScreen.style.display = 'none';
            }, 500);
        }

        async function fetchAnalytics() {
            try {
                const { data: trips } = await _supabase.from('trips').select('*, passenger:user_id(name), driver:driver_id(name)');
                const { data: users } = await _supabase.from('users').select('*');

                if (!trips || !users) return;

                const completed = trips.filter(t => t.status === 'completed');
                const ongoing = trips.filter(t => t.status === 'ongoing');
                const cancelled = trips.filter(t => t.status === 'cancelled');
                const revenue = completed.reduce((sum, t) => sum + (t.price || 0), 0);

                document.getElementById('total-trips').innerText = trips.length;
                document.getElementById('completed-trips').innerText = completed.length;
                document.getElementById('ongoing-trips').innerText = ongoing.length;
                document.getElementById('cancelled-trips').innerText = cancelled.length;
                document.getElementById('total-revenue').innerText = revenue + " Ø±.Ø³";
                document.getElementById('total-users').innerText = users.length;

                const tableBody = document.getElementById('activity-table');
                tableBody.innerHTML = trips.slice(0, 8).map(trip => `
                    <tr>
                        <td><b>#${trip.id.slice(0,5)}</b></td>
                        <td>${trip.passenger?.name || '---'}</td>
                        <td>${trip.driver?.name || 'Ù‚ÙŠØ¯ Ø§Ù„Ø¨Ø­Ø«'}</td>
                        <td>${trip.price} Ø±.Ø³</td>
                        <td><span class="badge ${trip.status === 'completed' ? 'badge-success' : trip.status === 'cancelled' ? 'badge-danger' : 'badge-ongoing'}">${translateStatus(trip.status)}</span></td>
                        <td>${new Date(trip.created_at).toLocaleTimeString('ar-SA')}</td>
                    </tr>
                `).join('');

            } catch (err) {
                console.error(err);
            }
        }

        function translateStatus(s) {
            const m = { 'completed': 'Ù…ÙƒØªÙ…Ù„Ø©', 'ongoing': 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ‚Ø¯Ù…', 'cancelled': 'Ù…Ù„ØºØ§Ø©', 'pending': 'Ù…Ø¹Ù„Ù‚Ø©' };
            return m[s] || s;
        }

        window.onload = fetchAnalytics;
    </script>
</body>
</html>
