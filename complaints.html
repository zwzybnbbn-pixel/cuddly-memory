<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙˆØµÙŠÙ„Ùˆ PRO | Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --primary: #6B2E82; 
            --secondary: #FF6B35; 
            --danger: #e74c3c; 
            --success: #2ecc71; 
            --dark: #1a1a1a; 
            --bg: #f8f9fa;
        }

        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; display: flex; }

        /* Sidebar Styling */
        .sidebar { width: 280px; background: var(--dark); height: 100vh; position: fixed; padding: 20px 0; color: white; overflow-y: auto; z-index: 1000; }
        .sidebar-header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .nav-item { display: flex; align-items: center; padding: 12px 25px; color: #bbb; text-decoration: none; transition: 0.3s; border-right: 4px solid transparent; }
        .nav-item i { margin-left: 15px; width: 20px; text-align: center; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.05); color: var(--secondary); border-right-color: var(--secondary); }

        /* Main Content */
        .main-content { margin-right: 280px; width: calc(100% - 280px); padding: 40px; min-height: 100vh; box-sizing: border-box; }
        
        /* Filters & Stats */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 25px; }
        .filter-btn { padding: 8px 20px; border-radius: 25px; border: 1px solid #ddd; background: white; cursor: pointer; font-family: 'Cairo'; font-weight: 600; transition: 0.3s; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Complaint Cards */
        .complaint-card { 
            background: white; border-radius: 16px; padding: 25px; margin-bottom: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-right: 6px solid #ddd;
            position: relative; animation: fadeIn 0.5s ease forwards;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .complaint-card.pending { border-right-color: var(--secondary); }
        .complaint-card.resolved { border-right-color: var(--success); }
        
        .header-info { display: flex; justify-content: space-between; align-items: flex-start; }
        .user-info { display: flex; flex-direction: column; gap: 5px; }
        .user-tag { padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 800; display: inline-block; width: fit-content; }
        .tag-driver { background: #e3f2fd; color: #1976d2; }
        .tag-client { background: #f3e5f5; color: var(--primary); }
        
        .sender-name { font-weight: 800; color: var(--dark); font-size: 18px; }
        .complaint-date { font-size: 12px; color: #999; }
        
        .content-box { background: #fcfaff; padding: 20px; border-radius: 12px; margin: 15px 0; font-size: 15px; border: 1px dashed #e0d0e6; color: #444; }
        
        .actions { display: flex; gap: 10px; }
        .btn { padding: 8px 18px; border-radius: 10px; border: none; cursor: pointer; font-family: 'Cairo'; font-weight: 700; display: flex; align-items: center; gap: 8px; text-decoration: none; font-size: 14px; transition: 0.2s; }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #27ae60; transform: scale(1.05); }
        .btn-phone { background: #f0f0f0; color: #333; }
        .btn-whatsapp { background: #25D366; color: white; }

        .empty-state { text-align: center; padding: 50px; color: #888; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h2 style="color: var(--secondary); margin:0;">ØªÙˆØµÙŠÙ„Ùˆ ğŸ›µ</h2>
            <small style="color: #666;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</small>
        </div>
        <nav>
            <a href="index.html" class="nav-item"><i class="fas fa-chart-pie"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</a>
            <a href="users_admin.html" class="nav-item"><i class="fas fa-users"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†</a>
            <a href="drivers_admin.html" class="nav-item"><i class="fas fa-motorcycle"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</a>
            <a href="trips.html" class="nav-item"><i class="fas fa-route"></i> Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</a>
            <a href="audit.html" class="nav-item"><i class="fas fa-wallet"></i> Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ</a>
            <a href="complaints.html" class="nav-item active"><i class="fas fa-exclamation-circle"></i> Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
            <a href="settings.html" class="nav-item"><i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <div>
                <h1>ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ğŸ“¬</h1>
                <p id="totalPending" style="color: var(--secondary); font-weight: bold;"></p>
            </div>
            <button onclick="loadComplaints()" class="btn btn-phone" style="background: white; border: 1px solid #ddd;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª <i class="fas fa-sync"></i></button>
        </div>

        <div class="filter-bar">
            <button class="filter-btn active" onclick="filterComplaints('all', this)">Ø§Ù„ÙƒÙ„</button>
            <button class="filter-btn" onclick="filterComplaints('pending', this)">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø­Ù„ âš ï¸</button>
            <button class="filter-btn" onclick="filterComplaints('resolved', this)">ØªÙ… Ø§Ù„Ø­Ù„ âœ…</button>
        </div>

        <div id="complaintsList">
            </div>
    </main>

    <script>
        let allComplaints = [];

        async function loadComplaints() {
            const { data: complaints, error } = await _supabase
                .from('complaints')
                .select(`
                    *,
                    users!user_id ( name, phone, type )
                `)
                .order('created_at', { ascending: false });

            if (error) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                return;
            }

            allComplaints = complaints;
            renderComplaints(allComplaints);
            
            const pendingCount = complaints.filter(c => c.status !== 'resolved').length;
            document.getElementById('totalPending').innerText = `Ù„Ø¯ÙŠÙƒ ${pendingCount} Ø´ÙƒÙˆÙ‰ ØªØ­ØªØ§Ø¬ Ù„ØªØ¯Ø®Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹`;
        }

        function renderComplaints(data) {
            const list = document.getElementById('complaintsList');
            list.innerHTML = data.length === 0 ? 
                '<div class="empty-state"><i class="fas fa-envelope-open fa-3x" style="margin-bottom:15px; opacity:0.3;"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</p></div>' : '';

            data.forEach(c => {
                const user = c.users || { name: 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø°ÙˆÙ', phone: '', type: 'unknown' };
                const date = new Date(c.created_at).toLocaleString('ar-EG', { dateStyle: 'medium', timeStyle: 'short' });
                const isResolved = c.status === 'resolved';

                list.innerHTML += `
                    <div class="complaint-card ${isResolved ? 'resolved' : 'pending'}">
                        <div class="header-info">
                            <div class="user-info">
                                <span class="user-tag ${user.type === 'driver' ? 'tag-driver' : 'tag-client'}">
                                    ${user.type === 'driver' ? '<i class="fas fa-motorcycle"></i> Ø³Ø§Ø¦Ù‚' : '<i class="fas fa-user"></i> Ø¹Ù…ÙŠÙ„'}
                                </span>
                                <span class="sender-name">${user.name}</span>
                                <span class="complaint-date"><i class="far fa-clock"></i> ${date}</span>
                            </div>
                            <div class="actions">
                                <a href="https://wa.me/${user.phone}" target="_blank" class="btn btn-whatsapp"><i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨</a>
                                <a href="tel:${user.phone}" class="btn btn-phone"><i class="fas fa-phone-alt"></i> Ø§ØªØµØ§Ù„</a>
                                ${!isResolved ? `<button class="btn btn-success" onclick="resolveComplaint('${c.id}')">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø´ÙƒÙˆÙ‰ âœ…</button>` : 
                                '<span style="color:var(--success); font-weight:bold; padding: 8px;"><i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>'}
                            </div>
                        </div>
                        <h3 style="margin: 15px 0 5px 0; font-size: 16px;">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ${c.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</h3>
                        <div class="content-box">
                            ${c.content}
                        </div>
                    </div>
                `;
            });
        }

        function filterComplaints(status, btn) {
            // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if(status === 'all') {
                renderComplaints(allComplaints);
            } else if(status === 'pending') {
                renderComplaints(allComplaints.filter(c => c.status !== 'resolved'));
            } else {
                renderComplaints(allComplaints.filter(c => c.status === 'resolved'));
            }
        }

        async function resolveComplaint(id) {
            if(!confirm("Ù‡Ù„ ØªØ£ÙƒØ¯Øª Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ")) return;

            const { error } = await _supabase
                .from('complaints')
                .update({ status: 'resolved' })
                .eq('id', id);

            if (!error) {
                loadComplaints();
            } else {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
            }
        }

        window.onload = loadComplaints;
    </script>
</body>
</html>
