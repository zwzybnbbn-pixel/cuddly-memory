<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</title>

<style>
body {
  background:#eef2f7;
  font-family:'Cairo', sans-serif;
  padding:20px;
}

h2 {
  text-align:center;
  margin-bottom:20px;
}

.card {
  background:white;
  padding:18px;
  border-radius:12px;
  margin-bottom:15px;
  box-shadow:0 3px 10px rgba(0,0,0,0.08);
}

.card strong { color:#007bff; }

.input {
  width:100%;
  padding:8px;
  border:1px solid #ccc;
  border-radius:8px;
  margin-top:6px;
}

.btn {
  padding:8px 12px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  margin-top:8px;
}

.save { background:#28a745; color:white; }
.delete { background:#dc3545; color:white; }

.reply-box {
  background:#eaf4ff;
  padding:10px;
  border-radius:10px;
  
}
</style>
</head>

<body>

<h2>ğŸ“‹ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h2>
<div id="list">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

<script type="module">
import { db, auth } from "./firebase.js";
import { 
  collection, doc, updateDoc, deleteDoc,
  onSnapshot, query, orderBy
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

import { onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";


// =========== Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ================
onAuthStateChanged(auth, user => {
  if (!user) {
    console.log("ØªÙ… Ø·Ø±Ø¯Ùƒ Ù„Ø£Ù†Ù‡ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„");
    window.location.href = "login.html";
  }
});


// =========== Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª ================
const list = document.getElementById("list");

const q = query(collection(db, "reports"), orderBy("created_at", "desc"));

onSnapshot(q, (snap) => {
  if (snap.empty) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª.</p>";
    return;
  }

  let html = "";

  snap.forEach(docSnap => {
    const r = docSnap.data();
    const id = docSnap.id;

    html += `
      <div class="card">

        <strong>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº:</strong> ${r.type ?? ""}<br>
        <strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${r.name ?? ""}<br>
        <strong>Ø§Ù„Ø­ÙŠ:</strong> ${r.location ?? ""}<br>
        <strong>Ø§Ù„ØªÙØ§ØµÙŠÙ„:</strong> ${r.details ?? ""}<br>
        <strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${r.status ?? "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"}<br>

        <hr>

        <label>âœ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ù„Ø§Øº:</label>
        <textarea id="reply-${id}" class="input">${r.reply ?? ""}</textarea>

        <label>âš™ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©:</label>
        <select id="status-${id}" class="input">
          <option ${r.status=="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"?"selected":""}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
          <option ${r.status=="Ø¬Ø§Ø±Ù Ø§Ù„Ø­Ù„"?"selected":""}>Ø¬Ø§Ø±Ù Ø§Ù„Ø­Ù„</option>
          <option ${r.status=="ØªÙ… Ø§Ù„Ø­Ù„"?"selected":""}>ØªÙ… Ø§Ù„Ø­Ù„</option>
        </select>

        <button class="btn save" onclick="saveUpdate('${id}')">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="btn delete" onclick="removeReport('${id}')">ğŸ—‘ Ø­Ø°Ù</button>

      </div>
    `;
  });

  list.innerHTML = html;
});


// =========== Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ================
window.saveUpdate = async (id) => {
  const reply = document.getElementById(`reply-${id}`).value;
  const status = document.getElementById(`status-${id}`).value;

  await updateDoc(doc(db, "reports", id), {
    reply,
    status
  });

  alert("âœ” ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù„Ø§Øº");
};


// =========== Ø­Ø°Ù Ø§Ù„Ø¨Ù„Ø§Øº ================
window.removeReport = async (id) => {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) {
    await deleteDoc(doc(db, "reports", id));
    alert("âœ” ØªÙ… Ø§Ù„Ø­Ø°Ù");
  }
};
</script>

</body>
</html>
