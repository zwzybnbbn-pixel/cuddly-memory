<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ø±ÙƒØ² Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ | ØªÙˆØµÙŠÙ„Ùˆ PRO</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #6B2E82; --secondary: #FF6B35; --success: #27AE60; --danger: #EB5757; --warning: #f1c40f; --bg: #f4f7f6; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; display: flex; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: #1a1a1a; color: white; height: 100vh; position: fixed; padding: 20px; box-sizing: border-box; z-index: 1000; }
        .nav-item { padding: 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #ccc; text-decoration: none; margin-bottom: 5px; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: white; }

        .main { margin-right: 260px; width: calc(100% - 260px); padding: 30px; box-sizing: border-box; min-height: 100vh; display: flex; flex-direction: column; }

        /* Stats Bar */
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid transparent; }
        .stat-card.total { border-color: var(--primary); }
        .stat-card.active { border-color: var(--success); }
        .stat-card.blocked { border-color: var(--danger); }
        .stat-card h3 { margin: 5px 0 0; font-size: 28px; font-weight: 800; color: #333; }

        /* New Layout Hierarchy */
        .content-container { display: flex; flex-direction: column; gap: 20px; flex: 1; }
        
        .control-panel { background: white; padding: 20px; border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Horizontal Drivers List */
        .drivers-scroll { 
            display: flex; 
            gap: 15px; 
            overflow-x: auto; 
            padding: 10px 5px; 
            margin-top: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) #eee;
        }
        .drivers-scroll::-webkit-scrollbar { height: 6px; }
        .drivers-scroll::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        /* User Card Adjusted for Horizontal */
        .user-card { 
            min-width: 320px; 
            background: #f9f9fb; 
            border: 1px solid #eee; 
            padding: 15px; 
            border-radius: 15px; 
            transition: 0.3s; 
            flex-shrink: 0;
        }
        .user-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        
        .driver-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .rating-stars { font-size: 13px; margin-top: 4px; display: flex; align-items: center; gap: 4px; }
        .gray-stars { opacity: 0.15; filter: grayscale(100%); }

        .badge { padding: 4px 12px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .status-active { background: #e8f5e9; color: var(--success); }
        .status-blocked { background: #ffebee; color: var(--danger); }
        
        .actions { margin-top: 12px; display: flex; gap: 8px; }
        button { cursor: pointer; border: none; font-family: 'Cairo'; font-weight: 600; border-radius: 8px; transition: 0.2s; }
        
        .btn-status-toggle { padding: 8px; flex: 2; font-size: 11px; }
        .btn-block { background: #fff1f1; color: var(--danger); border: 1px solid #ffcccc; }
        .btn-activate { background: #eefdf5; color: var(--success); border: 1px solid #ccffdd; }
        
        .btn-edit { background: #e3f2fd; color: #1976d2; padding: 8px; flex: 1; font-size: 11px; }
        .btn-delete { background: #eee; color: #666; width: 35px; }

        /* Wide Map at Bottom */
        #map { 
            width: 100%; 
            height: 500px; 
            border-radius: 25px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.08); 
            border: 5px solid white; 
            z-index: 1; 
        }
        
        /* Modal Styles */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; backdrop-filter: blur(5px); }
        .modal-content { background:white; padding:40px; border-radius:30px; width:380px; }
        .modal-content input { width:100%; margin-bottom:15px; padding:15px; border-radius:12px; border: 1.5px solid #eee; font-family: 'Cairo'; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="color: var(--secondary); text-align: center; margin-bottom: 40px;">ØªÙˆØµÙŠÙ„Ùˆ ğŸ›µ</h2>
        <a href="index.html" class="nav-item"><i class="fas fa-chart-line"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</a>
        <a href="users_admin.html" class="nav-item"><i class="fas fa-user-friends"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†</a>
        <a href="drivers_admin.html" class="nav-item active"><i class="fas fa-id-card"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</a>
        <a href="users.html" class="nav-item"><i class="fas fa-users-cog"></i> Ø§Ù„ÙƒÙ„ (Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆÙ…ÙˆØ§Ø·Ù†ÙŠÙ†)</a>
        <a href="requests.html" class="nav-item"><i class="fas fa-user-plus"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>
        <a href="trips.html" class="nav-item"><i class="fas fa-route"></i> Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</a>
        <a href="audit.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i> Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ</a>
        <a href="report.html" class="nav-item"><i class="fas fa-file-alt"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
        <a href="complaints.html" class="nav-item"><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
        <a href="settings.html" class="nav-item"><i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</a>
    </div>

    <div class="main">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div>
                <h1 style="margin:0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ - Ø¹ØªÙ‚ ğŸš›</h1>
                <p style="color:#777; margin:5px 0 0">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©</p>
            </div>
            <button onclick="openAddModal()" style="background:var(--primary); color:white; padding:12px 25px; border-radius:15px; font-weight:bold;">
                <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ø¨ØªÙ†
            </button>
        </div>

        <div class="stats-bar">
            <div class="stat-card total"><small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ¨Ø§ØªÙ†</small><h3 id="stat-total">0</h3></div>
            <div class="stat-card active"><small>Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</small><h3 id="stat-active" style="color:var(--success)">0</h3></div>
            <div class="stat-card blocked"><small>Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</small><h3 id="stat-blocked" style="color:var(--danger)">0</h3></div>
        </div>
        
        <div class="content-container">
            <div class="control-panel">
                <div style="position: relative;">
                    <i class="fas fa-search" style="position: absolute; right: 15px; top: 12px; color: #aaa;"></i>
                    <input type="text" id="search-input" onkeyup="filterDrivers()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„..." 
                           style="width: 100%; padding: 10px 40px 10px 15px; border-radius: 12px; border: 1.5px solid #eee; font-family: 'Cairo'; outline: none; box-sizing: border-box;">
                </div>
                <div class="drivers-scroll" id="drivers-list">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...</div>
            </div>

            <div id="map"></div>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="margin-top:0; color:var(--primary)">Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ø¨ØªÙ†</h2>
            <input type="hidden" id="edit-user-id">
            <input type="text" id="user-name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="text" id="user-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
            <button onclick="processUser()" style="width:100%; background:var(--success); color:white; padding:15px; border-radius:15px; border:none; font-size:16px; font-weight:bold;">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button onclick="closeModal()" style="width:100%; margin-top:10px; background:none; color:#888; border:none;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script>
        // ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ Ù„ÙŠÙØªØ­ Ø¹Ù„Ù‰ Ø¹ØªÙ‚ØŒ Ø´Ø¨ÙˆØ© Ù…Ø¨Ø§Ø´Ø±Ø©
        let map = L.map('map').setView([14.5377, 46.8319], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let markers = {};
        let allDrivers = [];

        function getStars(rating) {
            const val = parseFloat(rating) || 0;
            const r = Math.round(val);
            return 'â­'.repeat(r) + `<span class="gray-stars">${'â­'.repeat(5 - r)}</span>`;
        }

        async function loadDrivers() {
            const { data, error } = await _supabase.from('users').select('*').eq('type', 'driver').order('created_at', { ascending: false });
            if (error) return;
            allDrivers = data;
            updateStats(data);
            renderDrivers(data);
            setTimeout(() => { map.invalidateSize(); }, 500);
        }

        function updateStats(list) {
            document.getElementById('stat-total').innerText = list.length;
            document.getElementById('stat-blocked').innerText = list.filter(d => d.status === 'blocked').length;
        }

        function renderDrivers(list) {
            const container = document.getElementById('drivers-list');
            container.innerHTML = list.map(d => {
                const isActive = d.status === 'active';
                return `
                <div class="user-card">
                    <div class="driver-header">
                        <div>
                            <b style="font-size:15px;">${d.name}</b>
                            <div class="rating-stars">${getStars(d.rating)} <span style="color:#888; font-size:11px;">(${parseFloat(d.rating || 0).toFixed(1)})</span></div>
                        </div>
                        <span class="badge ${isActive ? 'status-active' : 'status-blocked'}">${isActive ? 'Ù†Ø´Ø·' : 'Ù…Ø­Ø¸ÙˆØ±'}</span>
                    </div>
                    <div style="margin-top:8px; font-size:12px; color:#666;"><i class="fas fa-phone-alt"></i> ${d.phone || '---'}</div>
                    <div class="actions">
                        <button class="btn-status-toggle ${isActive ? 'btn-block' : 'btn-activate'}" onclick="toggleStatus('${d.id}', '${d.status}')">
                            <i class="fas ${isActive ? 'fa-user-slash' : 'fa-check-circle'}"></i> ${isActive ? 'Ø­Ø¸Ø±' : 'ØªÙØ¹ÙŠÙ„'}
                        </button>
                        <button class="btn-edit" onclick="openEditModal('${d.id}', '${d.name}', '${d.phone}')">ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="btn-delete" onclick="deleteUser('${d.id}')"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        async function toggleStatus(id, current) {
            const next = current === 'active' ? 'blocked' : 'active';
            const { error } = await _supabase.from('users').update({ status: next }).eq('id', id);
            if (!error) {
                allDrivers = allDrivers.map(d => d.id === id ? {...d, status: next} : d);
                updateStats(allDrivers);
                renderDrivers(allDrivers);
            }
        }

        function filterDrivers() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = allDrivers.filter(d => d.name.toLowerCase().includes(query) || (d.phone && d.phone.includes(query)));
            renderDrivers(filtered);
        }

        async function processUser() {
            const id = document.getElementById('edit-user-id').value;
            const name = document.getElementById('user-name').value;
            const phone = document.getElementById('user-phone').value;
            if (id) {
                await _supabase.from('users').update({ name, phone }).eq('id', id);
            } else {
                await _supabase.from('users').insert([{ name, phone, type: 'driver', status: 'active', rating: 0 }]);
            }
            closeModal(); loadDrivers();
        }

        function openAddModal() {
            document.getElementById('edit-user-id').value = '';
            document.getElementById('modalTitle').innerText = 'Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ø¨ØªÙ† Ø¬Ø¯ÙŠØ¯';
            document.getElementById('userModal').style.display = 'flex';
        }

        function openEditModal(id, name, phone) {
            document.getElementById('edit-user-id').value = id;
            document.getElementById('modalTitle').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            document.getElementById('user-name').value = name;
            document.getElementById('user-phone').value = phone;
            document.getElementById('userModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('userModal').style.display = 'none'; }

        async function deleteUser(id) {
            if (confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø§Ø¦Ù‚ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) { 
                await _supabase.from('users').delete().eq('id', id); 
                loadDrivers(); 
            }
        }

        const channel = _supabase.channel('online-drivers');
        channel.on('presence', { event: 'sync' }, () => {
            const state = channel.presenceState();
            document.getElementById('stat-active').innerText = Object.keys(state).length;
        }).subscribe();

        window.onload = loadDrivers;
    </script>
</body>
</html>
