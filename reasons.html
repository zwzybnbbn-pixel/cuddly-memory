<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الأسباب</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="nav">
  <a href="index.html">الرئيسية</a>
  <a href="alerts.html">التنبيهات</a>
  <a href="reasons.html">الأسباب</a>
  <a href="schedule.html">الجدول</a>
  <a href="reports.html">البلاغات</a>
</div>

<div class="section">
  <h2>سبب الانقطاع</h2>
  <div id="reason-box"></div>
</div>

<script type="module">
import { db } from "./firebase.js";
import { collection, getDocs, query, orderBy } 
  from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const box = document.getElementById("reason-box");

function formatDateMaybe(ts) {
  if (!ts) return "—";
  // إذا كان Timestamp من Firestore
  if (typeof ts.toDate === "function") {
    return ts.toDate().toLocaleString("ar-EG", {
      year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit"
    });
  }
  // إذا كانت سلسلة نصية أو رقم
  const d = new Date(ts);
  if (isNaN(d)) return String(ts);
  return d.toLocaleString("ar-EG", {
    year: "numeric", month: "long", day: "numeric", hour: "2-digit", minute: "2-digit"
  });
}

async function loadReasons() {
  box.innerHTML = "<p>جاري التحميل...</p>";
  try {
    // اجلب جميع المستندات، مفروزة حسب updated_at تنازلياً (آخرها أولاً)
    const q = query(collection(db, "reasons"), orderBy("updated_at", "desc"));
    const snap = await getDocs(q);

    if (snap.empty) {
      box.innerHTML = "<p>لا توجد بيانات.</p>";
      return;
    }

    let html = "";
    snap.forEach(doc => {
      const r = doc.data();
      html += `
        <div class="item" style="background:#ffa94d; padding:12px; margin-bottom:12px;">
          <p><strong>السبب:</strong> ${r.text || "—"}</p>
          <p style="opacity:.8; font-size:14px;"><strong>آخر تحديث:</strong> ${formatDateMaybe(r.updated_at)}</p>
        </div>
      `;
    });

    box.innerHTML = html;

  } catch (err) {
    box.innerHTML = "<p style='color:red'>خطأ في الاتصال بقاعدة البيانات. افتح Console لرؤية الخطأ.</p>";
    console.error("loadReasons error:", err);
  }
}

loadReasons();
</script>

</body>
</html>
