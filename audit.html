<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙˆØµÙŠÙ„Ùˆ PRO | Ø§Ù„Ø¬Ø±Ø¯ ÙˆØ§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #6B2E82; --secondary: #FF6B35; --danger: #e74c3c; --success: #27ae60; --dark: #2c3e50; }
        body { font-family: 'Cairo', sans-serif; background: #f4f7f6; margin: 0; display: flex; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: #1a1a1a; height: 100vh; position: fixed; padding: 20px; color: white; box-sizing: border-box; }
        .nav-item { padding: 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #ccc; text-decoration: none; margin-bottom: 5px; }
        .nav-item.active { background: var(--primary); color: white; }

        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 40px; box-sizing: border-box; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .control-panel { 
            background: white; padding: 20px; border-radius: 20px; 
            margin-bottom: 30px; display: flex; align-items: center; 
            gap: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border-right: 6px solid var(--secondary);
        }
        .control-panel input#commissionInput { width: 80px; padding: 10px; border: 2px solid #eee; border-radius: 10px; text-align: center; font-weight: 800; font-size: 18px; }
        
        .btn-update { background: var(--dark); color: white; border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; transition: 0.3s; }
        .btn-update:hover { background: #000; }

        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .summary-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: 20px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .stat-box h3 { font-size: 14px; color: #777; margin: 0; }
        .stat-box div { font-size: 24px; font-weight: 800; margin-top: 10px; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .audit-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: right; padding: 15px; border-bottom: 2px solid #eee; color: var(--dark); }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; }

        /* Ø®Ø§Ù†Ø© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ */
        .pay-box { display: flex; align-items: center; gap: 8px; }
        .pay-box input { width: 90px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-family: 'Cairo'; }
        .btn-pay { background: var(--success); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-family: 'Cairo'; font-size: 12px; }
        .btn-pay:hover { opacity: 0.8; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="color: var(--secondary); text-align: center;">ØªÙˆØµÙŠÙ„Ùˆ ğŸ›µ</h2>
        
        <a href="index.html" class="nav-item active"><i class="fas fa-chart-line"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</a>
        <a href="users_admin.html" class="nav-item"><i class="fas fa-user-friends"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†</a>
        <a href="drivers_admin.html" class="nav-item"><i class="fas fa-id-card"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</a>
        <a href="users.html" class="nav-item"><i class="fas fa-users-cog"></i> Ø§Ù„ÙƒÙ„ (Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆÙ…ÙˆØ§Ø·Ù†ÙŠÙ†)</a>
        <a href="requests.html" class="nav-item"><i class="fas fa-user-plus"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>
        <a href="trips.html" class="nav-item"><i class="fas fa-route"></i> Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</a>

                        <a href="report.html" class="nav-item"><i class="fas fa-route"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±<
        <a href="complaints.html" class="nav-item"><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
        <a href="settings.html" class="nav-item"><i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…>
    </div>

    <div class="main-content">
        <h1>Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… ğŸ§¾</h1>

        <div class="control-panel">
            <label><i class="fas fa-percentage"></i> Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label>
            <input type="number" id="commissionInput" value="15">
            <span>%</span>
            <button class="btn-update" onclick="performAudit()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</button>
            <div style="margin-right: auto; color: #888; font-size: 12px;">ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ø³Ø¨Ø© Ù‡Ù†Ø§ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø­Ø³Ø§Ø¨ "Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù" ÙÙˆØ±Ø§Ù‹ ÙˆØ­ÙØ¸Ù‡Ø§ Ù„Ù„Ù†Ø¸Ø§Ù….</div>
        </div>

        <div class="summary-bar">
            <div class="stat-box" style="border-top: 4px solid var(--success);">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø´ (Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†)</h3>
                <div id="totalCash" style="color: var(--success);">0 Ø±.Ø³</div>
            </div>
            <div class="stat-box" style="border-top: 4px solid var(--primary);">
                <h3>Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (Ø­Ø³Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø©)</h3>
                <div id="targetComm" style="color: var(--primary);">0 Ø±.Ø³</div>
            </div>
            <div class="stat-box" style="border-top: 4px solid var(--danger);">
                <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
                <div id="actualDebt" style="color: var(--danger);">0 Ø±.Ø³</div>
            </div>
        </div>

        <div class="audit-card">
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                        <th>Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                        <th>Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</th>
                        <th>Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„ÙØ¹Ù„ÙŠ</th>
                        <th>ØªØ³Ø¯ÙŠØ¯ Ù…Ø¨Ù„Ø¹ ÙƒØ§Ø´</th>
                    </tr>
                </thead>
                <tbody id="auditBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        async function performAudit() {
            const commissionRate = parseFloat(document.getElementById('commissionInput').value) / 100;
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const { data: drivers } = await _supabase.from('users').select('*').eq('type', 'driver');
            const { data: trips } = await _supabase.from('trips').select('*').eq('status', 'completed');

            let tCash = 0, tTarget = 0, tActual = 0;
            const tbody = document.getElementById('auditBody');
            tbody.innerHTML = '';

            drivers.forEach(d => {
                const driverTrips = trips.filter(t => t.driver_id === d.id);
                const sumCash = driverTrips.reduce((acc, curr) => acc + (curr.price || 0), 0);
                const target = sumCash * commissionRate;
                const actual = d.debt || 0;

                tCash += sumCash;
                tTarget += target;
                tActual += actual;

                tbody.innerHTML += `
                    <tr>
                        <td><strong>${d.name}</strong></td>
                        <td>${sumCash.toFixed(2)} Ø±.Ø³</td>
                        <td style="color:var(--primary)">${target.toFixed(2)} Ø±.Ø³</td>
                        <td style="color:var(--danger); font-weight:bold;">${actual.toFixed(2)} Ø±.Ø³</td>
                        <td>
                            <div class="pay-box">
                                <input type="number" id="pay-${d.id}" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
                                <button class="btn-pay" onclick="payDebt('${d.id}', '${d.name}')">ØªØ³Ø¯ÙŠØ¯ âœ…</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            document.getElementById('totalCash').innerText = tCash.toFixed(2) + " Ø±.Ø³";
            document.getElementById('targetComm').innerText = tTarget.toFixed(2) + " Ø±.Ø³";
            document.getElementById('actualDebt').innerText = tActual.toFixed(2) + " Ø±.Ø³";

            // Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø¨Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            await _supabase.from('settings').upsert({ setting_key: 'app_commission', setting_value: (commissionRate * 100).toString() });
        }

        async function payDebt(driverId, driverName) {
            const amount = parseFloat(document.getElementById(`pay-${driverId}`).value);
            if (!amount || amount <= 0) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");

            if (confirm(`Ù‡Ù„ Ø§Ø³ØªÙ„Ù…Øª ${amount} Ø±ÙŠØ§Ù„ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driverName}ØŸ Ø³ÙŠØªÙ… Ø®ØµÙ…Ù‡Ø§ Ù…Ù† Ø¯ÙŠÙ†Ù‡.`)) {
                // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                const { data } = await _supabase.from('users').select('debt').eq('id', driverId).single();
                const newDebt = (data.debt || 0) - amount;

                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const { error } = await _supabase.from('users').update({ debt: newDebt }).eq('id', driverId);

                if (!error) {
                    alert("ØªÙ… Ø§Ù„ØªØ³Ø¯ÙŠØ¯ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
                    performAudit(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
                } else {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯");
                }
            }
        }

        window.onload = performAudit;
    </script>
</body>
</html>
