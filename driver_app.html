<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تطبيق السائق | البث النشط</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #0f172a; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #1e293b; padding: 40px; border-radius: 24px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); width: 350px; border: 1px solid #334155; }
        .live-indicator { background: rgba(34, 197, 94, 0.1); color: #4ade80; padding: 10px 20px; border-radius: 50px; font-weight: bold; font-size: 14px; margin: 20px 0; display: inline-flex; align-items: center; gap: 8px; border: 1px solid rgba(74, 222, 128, 0.2); }
        .dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; animation: blink 1.2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.8); } }
        .driver-name { font-size: 22px; margin: 15px 0 5px 0; font-weight: 700; }
        .driver-id { font-size: 12px; color: #64748b; font-family: monospace; }
        #status-msg { color: #94a3b8; font-size: 14px; margin-top: 20px; }
    </style>
</head>
<body>

    <div class="card">
        <div id="loader">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>جاري الاتصال بالنظام...</p>
        </div>

        <div id="driver-content" style="display: none;">
            <img id="avatar" src="" style="width: 90px; height: 90px; border-radius: 50%; border: 4px solid #334155; object-fit: cover;">
            <div class="driver-name" id="name">---</div>
            <div class="driver-id">ID: 49dca6fa...</div>

            <div class="live-indicator">
                <div class="dot"></div>
                بث مباشر للوحة التحكم
            </div>

            <p id="status-msg">أنت الآن تظهر كـ "متصل" لدى الإدارة</p>
        </div>
    </div>

    <script>
        // المعرف الخاص بك
        const DRIVER_ID = "49dca6fa-cd9f-43ef-824a-0e51ddfe82da";

        async function startDriverSession() {
            try {
                // 1. جلب بيانات السائق من Supabase
                const { data: driver, error } = await _supabase
                    .from('users')
                    .select('*')
                    .eq('id', DRIVER_ID)
                    .single();

                if (error || !driver) {
                    document.getElementById('loader').innerHTML = "<p style='color:#ef4444'>⚠️ فشل العثور على السائق في قاعدة البيانات</p>";
                    return;
                }

                // 2. تحديث الواجهة
                document.getElementById('loader').style.display = 'none';
                document.getElementById('driver-content').style.display = 'block';
                document.getElementById('name').innerText = driver.name;
                document.getElementById('avatar').src = driver.profile_image || `https://ui-avatars.com/api/?name=${driver.name}&background=6B2E82&color=fff`;

                // 3. بدء البث المباشر (Presence)
                const channel = _supabase.channel('online-drivers', {
                    config: { presence: { key: DRIVER_ID } }
                });

                channel.subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        await channel.track({
                            id: DRIVER_ID,
                            name: driver.name,
                            type: 'driver',
                            online_at: new Date().toISOString()
                        });
                        console.log("✅ تم الاتصال بقناة البث");
                    }
                });

                // 4. تحديث طابع الوقت لآخر ظهور في القاعدة
                await _supabase.from('users').update({ last_login: new Date() }).eq('id', DRIVER_ID);

            } catch (err) {
                console.error(err);
                document.getElementById('loader').innerText = "خطأ في الاتصال بالسيرفر";
            }
        }
        // داخل دالة startPresence(driver)
function startPresence(driver) {
    const channel = _supabase.channel('online-drivers', {
        config: { presence: { key: driver.id } }
    });

    channel.subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
            // تتبع الموقع الجغرافي وإرساله رقمياً
            if ("geolocation" in navigator) {
                navigator.geolocation.watchPosition(async (position) => {
                    await channel.track({
                        id: driver.id,
                        name: driver.name,
                        lat: position.coords.latitude.toFixed(6), // خط العرض
                        lng: position.coords.longitude.toFixed(6), // خط الطول
                        online_at: new Date().toISOString()
                    });
                }, (err) => console.error("إذن الموقع مرفوض"), { enableHighAccuracy: true });
            }
        }
    });
}


        window.onload = startDriverSession;
    </script>
</body>
</html>
