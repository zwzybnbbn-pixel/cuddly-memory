<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>تطبيق السائق | البث والتعقب المباشر</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; background: #0f172a; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #1e293b; padding: 40px; border-radius: 24px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); width: 350px; border: 1px solid #334155; }
        .live-indicator { background: rgba(34, 197, 94, 0.1); color: #4ade80; padding: 10px 20px; border-radius: 50px; font-weight: bold; font-size: 14px; margin: 15px 0; display: inline-flex; align-items: center; gap: 8px; border: 1px solid rgba(74, 222, 128, 0.2); }
        .dot { width: 10px; height: 10px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e; animation: blink 1.2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.8); } }
        .driver-name { font-size: 22px; margin: 15px 0 5px 0; font-weight: 700; }
        .coords-box { background: #0f172a; padding: 15px; border-radius: 12px; margin-top: 20px; border: 1px dashed #334155; }
        .coords-title { font-size: 10px; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
        .coords-values { font-family: monospace; color: #38bdf8; font-size: 14px; }
        #status-msg { color: #94a3b8; font-size: 13px; margin-top: 15px; }
    </style>
</head>
<body>

    <div class="card">
        <div id="loader">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p>جاري بدء البث المباشر...</p>
        </div>

        <div id="driver-content" style="display: none;">
            <img id="avatar" src="" style="width: 90px; height: 90px; border-radius: 50%; border: 4px solid #334155; object-fit: cover;">
            <div class="driver-name" id="name">---</div>

            <div class="live-indicator">
                <div class="dot"></div>
                بث الموقع حي (GPS)
            </div>

            <div class="coords-box">
                <div class="coords-title">الإحداثيات الحالية</div>
                <div class="coords-values" id="coords-display">في انتظار تحديد الموقع...</div>
            </div>

            <p id="status-msg">إحداثياتك تظهر الآن رقمياً في لوحة التحكم</p>
        </div>
    </div>

    <script>
        const DRIVER_ID = "49dca6fa-cd9f-43ef-824a-0e51ddfe82da";
        let geoWatchId = null;

        async function startDriverSession() {
            try {
                // 1. جلب بيانات السائق
                const { data: driver, error } = await _supabase
                    .from('users')
                    .select('*')
                    .eq('id', DRIVER_ID)
                    .single();

                if (error || !driver) {
                    document.getElementById('loader').innerHTML = "<p style='color:#ef4444'>⚠️ لم يتم العثور على بيانات السائق</p>";
                    return;
                }

                // 2. تحديث الواجهة
                document.getElementById('loader').style.display = 'none';
                document.getElementById('driver-content').style.display = 'block';
                document.getElementById('name').innerText = driver.name;
                document.getElementById('avatar').src = driver.profile_image || `https://ui-avatars.com/api/?name=${driver.name}&background=6B2E82&color=fff`;

                // 3. الاتصال بالقناة وبدء التعقب
                const channel = _supabase.channel('online-drivers', {
                    config: { presence: { key: DRIVER_ID } }
                });

                channel.subscribe(async (status) => {
                    if (status === 'SUBSCRIBED') {
                        startLocationTracking(channel, driver.name);
                    }
                });

                // 4. تحديث آخر ظهور
                await _supabase.from('users').update({ last_login: new Date() }).eq('id', DRIVER_ID);

            } catch (err) {
                console.error(err);
                document.getElementById('loader').innerText = "خطأ في الاتصال";
            }
        }

        function startLocationTracking(channel, driverName) {
            if ("geolocation" in navigator) {
                geoWatchId = navigator.geolocation.watchPosition(async (position) => {
                    const lat = position.coords.latitude.toFixed(6);
                    const lng = position.coords.longitude.toFixed(6);

                    // تحديث الشاشة للسائق
                    document.getElementById('coords-display').innerText = `${lat}, ${lng}`;

                    // بث البيانات للوحة التحكم
                    await channel.track({
                        id: DRIVER_ID,
                        name: driverName,
                        type: 'driver',
                        lat: lat,
                        lng: lng,
                        online_at: new Date().toISOString()
                    });

                    console.log("GPS Update Sent");
                }, 
                (err) => {
                    document.getElementById('coords-display').innerHTML = "<span style='color:#f87171'>يجب تفعيل GPS</span>";
                }, 
                { enableHighAccuracy: true });
            } else {
                alert("متصفحك لا يدعم تحديد الموقع");
            }
        }

        window.onload = startDriverSession;
    </script>
</body>
</html>
