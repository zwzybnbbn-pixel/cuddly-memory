<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙˆØµÙŠÙ„Ùˆ PRO | Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·Ù„Ù‚ ğŸ›¡ï¸</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #6B2E82; --secondary: #FF6B35; --danger: #e74c3c; --success: #27ae60; --dark: #1a1a1a; }
        body { font-family: 'Cairo', sans-serif; background: #f4f7f6; margin: 0; display: flex; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--dark); color: white; height: 100vh; position: fixed; padding: 20px; box-sizing: border-box; }
        .nav-item { padding: 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #ccc; text-decoration: none; margin-bottom: 5px; }
        .nav-item.active { background: var(--primary); color: white; }

        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 40px; box-sizing: border-box; }

        /* Power Cards */
        .power-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; }
        .card { background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { padding: 20px; font-weight: 800; display: flex; justify-content: space-between; align-items: center; background: #fcfcfc; border-bottom: 1px solid #eee; }
        .card-body { padding: 25px; }

        /* Emergency Switch */
        .emergency-box { border: 2px solid var(--danger); border-radius: 15px; padding: 20px; background: #fff5f5; }
        textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-family: 'Cairo'; margin-bottom: 15px; resize: none; }
        
        .btn { border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-family: 'Cairo'; font-weight: bold; transition: 0.3s; width: 100%; }
        .btn-stop { background: var(--danger); color: white; }
        .btn-start { background: var(--success); color: white; }
        .btn-settle { background: var(--primary); color: white; }

        /* Log Console */
        .console { background: #1a1a1a; color: #00ff00; padding: 15px; border-radius: 12px; font-family: monospace; font-size: 13px; height: 150px; overflow-y: auto; margin-top: 20px; border: 3px solid #333; }
        
        .status-banner { padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="color: var(--secondary); text-align: center;">ØªÙˆØµÙŠÙ„Ùˆ ğŸ›µ</h2>
        <a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="trips.html" class="nav-item"><i class="fas fa-route"></i> Ø§Ù„Ø±Ø­Ù„Ø§Øª</a>
        <a href="admin_control.html" class="nav-item active"><i class="fas fa-user-shield"></i> Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø·Ù„Ù‚</a>
    </div>

    <div class="main-content">
        <h1>Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø¨Ø§Ù„Ù…Ù†ØµØ© ğŸ›¡ï¸</h1>

        <div class="power-grid">
            <div class="card" style="grid-column: span 2;">
                <div class="card-header" style="color: var(--danger);">ØªØ­ÙƒÙ… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (Kill Switch) <i class="fas fa-power-off"></i></div>
                <div class="card-body">
                    <div id="statusBanner" class="status-banner">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…...</div>
                    <label>Ø³Ø¨Ø¨ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙÙˆØ±Ø§Ù‹):</label>
                    <textarea id="closure_reason" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù†Ø¹ØªØ°Ø±ØŒ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªÙˆÙ‚Ù Ù„Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø·Ø§Ø±Ø¦Ø© Ø­ØªÙ‰ Ø§Ù„Ø³Ø§Ø¹Ø© 6 Ù…Ø³Ø§Ø¡Ù‹..."></textarea>
                    
                    <div style="display: flex; gap: 15px;">
                        <button class="btn btn-stop" onclick="updateSystemStatus('closed')">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¢Ù† ğŸ›‘</button>
                        <button class="btn btn-start" onclick="updateSystemStatus('open')">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ğŸš€</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">ØªØ­ØµÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† (ÙƒØ§Ø´) <i class="fas fa-hand-holding-usd"></i></div>
                <div class="card-body">
                    <p style="font-size: 13px; color: #666;">Ø¹Ù†Ø¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© ÙƒØ§Ø´ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ØŒ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ Ù‡Ù†Ø§ Ù„ØªØµÙÙŠØ± Ø¯ÙŠÙ†Ù‡.</p>
                    <input type="text" id="driver_phone" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø³Ø§Ø¦Ù‚" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;">
                    <input type="number" id="paid_amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ„Ù… (Ø±ÙŠØ§Ù„)" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px; border:1px solid #ddd;">
                    <button class="btn btn-settle" onclick="settleDebt()">ØªØ³ÙˆÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØµÙÙŠØ± Ø§Ù„Ø¯ÙŠÙ†</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Ø³Ø¬Ù„ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Logs) <i class="fas fa-terminal"></i></div>
                <div class="card-body">
                    <div class="console" id="logConsole">
                        [Ø§Ù„Ù†Ø¸Ø§Ù…] Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø£ÙˆØ§Ù…Ø±...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
        window.onload = async () => {
            const { data } = await _supabase.from('settings').select('*');
            const status = data.find(i => i.setting_key === 'app_status')?.setting_value;
            const reason = data.find(i => i.setting_key === 'closure_reason')?.setting_value;
            
            const banner = document.getElementById('statusBanner');
            if(status === 'open') {
                banner.innerText = "Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨ØµÙˆØ±Ø© Ø·Ø¨ÙŠØ¹ÙŠØ© âœ…";
                banner.style.background = "#e8f5e9";
                banner.style.color = "#2e7d32";
            } else {
                banner.innerText = "Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªÙˆÙ‚Ù Ø­Ø§Ù„ÙŠØ§Ù‹ âŒ";
                banner.style.background = "#ffebee";
                banner.style.color = "#c62828";
            }
            document.getElementById('closure_reason').value = reason || "";
        };

        async function updateSystemStatus(newStatus) {
            const reason = document.getElementById('closure_reason').value;
            if(newStatus === 'closed' && !reason) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù");

            const { error } = await _supabase.from('settings').upsert([
                { setting_key: 'app_status', setting_value: newStatus },
                { setting_key: 'closure_reason', setting_value: reason }
            ]);

            if(!error) {
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…");
                addLog(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ${newStatus}. Ø§Ù„Ø³Ø¨Ø¨: ${reason}`);
                location.reload();
            }
        }

        async function settleDebt() {
            const phone = document.getElementById('driver_phone').value;
            const amount = parseFloat(document.getElementById('paid_amount').value);

            const { data: driver } = await _supabase.from('users').select('id, debt, name').eq('phone', phone).single();

            if(driver) {
                const currentDebt = driver.debt || 0;
                const newDebt = currentDebt - amount;
                
                await _supabase.from('users').update({ debt: newDebt }).eq('id', driver.id);
                addLog(`ØªÙ… ØªØ­ØµÙŠÙ„ ${amount} Ø±ÙŠØ§Ù„ Ù…Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ ${driver.name}. Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${newDebt}`);
                alert("ØªÙ…Øª ØªØ³ÙˆÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
            } else {
                alert("Ø§Ù„Ø³Ø§Ø¦Ù‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù‡Ø°Ø§");
            }
        }

        function addLog(msg) {
            const console = document.getElementById('logConsole');
            const time = new Date().toLocaleTimeString();
            console.innerHTML += `<br>[${time}] ${msg}`;
            console.scrollTop = console.scrollHeight;
        }
    </script>
</body>
</html>
