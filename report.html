<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙˆØµÙŠÙ„Ùˆ PRO | Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #6B2E82; --secondary: #FF6B35; --success: #27AE60; --bg: #f4f7f6; }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); margin: 0; display: flex; }
        
        .sidebar { width: 260px; background: #1a1a1a; color: white; height: 100vh; position: fixed; padding: 20px; box-sizing: border-box; }
        .nav-item { padding: 15px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #ccc; text-decoration: none; margin-bottom: 5px; }
        .nav-item.active { background: var(--primary); color: white; }

        .main-content { margin-right: 260px; width: calc(100% - 260px); padding: 30px; }

        /* Filter Bar */
        .filter-card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; display: flex; gap: 20px; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; gap: 8px; flex: 1; }
        input[type="date"] { padding: 10px; border: 1px solid #ddd; border-radius: 10px; font-family: 'Cairo'; }
        
        .btn-search { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: bold; }
        .btn-excel { background: var(--success); color: white; border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: bold; }

        /* Stats Row */
        .report-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: 15px; text-align: center; border-bottom: 4px solid var(--primary); }

        /* Table Style */
        .report-table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .report-table th { background: #f8f9fa; padding: 15px; text-align: right; color: #666; font-size: 14px; }
        .report-table td { padding: 15px; border-top: 1px solid #eee; font-size: 14px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="color: var(--secondary); text-align: center;">ØªÙˆØµÙŠÙ„Ùˆ ğŸ›µ</h2>

        <a href="index.html" class="nav-item active"><i class="fas fa-chart-line"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</a>
        <a href="users_admin.html" class="nav-item"><i class="fas fa-user-friends"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙŠÙ†</a>
        <a href="drivers_admin.html" class="nav-item"><i class="fas fa-id-card"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</a>
        <a href="users.html" class="nav-item"><i class="fas fa-users-cog"></i> Ø§Ù„ÙƒÙ„ (Ø³Ø§Ø¦Ù‚ÙŠÙ† ÙˆÙ…ÙˆØ§Ø·Ù†ÙŠÙ†)</a>
        <a href="requests.html" class="nav-item"><i class="fas fa-user-plus"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>
        <a href="trips.html" class="nav-item"><i class="fas fa-route"></i> Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª</a>
        <a href="audit.html" class="nav-item"><i class="fas fa-file-invoice-dollar"></i> Ø§Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ</a>
        <a href="complaints.html" class="nav-item"><i class="fas fa-exclamation-triangle"></i> Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</a>
        <a href="settings.html" class="nav-item"><i class="fas fa-cog"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</a>
    </div>

    <div class="main-content">
        <h1>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­ØµÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ ğŸ“Š</h1>
        
        <div class="filter-card">
            <div class="filter-group">
                <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                <input type="date" id="endDate">
            </div>
            <button class="btn-search" onclick="fetchReportData()"><i class="fas fa-sync"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            <button class="btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> ØªØµØ¯ÙŠØ± Excel</button>
        </div>

        <div class="report-stats">
            <div class="stat-box"> <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø­Ù„Ø§Øª</small> <h2 id="totalTrips">0</h2> </div>
            <div class="stat-box"> <small>ØµØ§ÙÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</small> <h2 id="totalAmount" style="color: var(--success)">0 Ø±.Ø³</h2> </div>
            <div class="stat-box"> <small>Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±Ø­Ù„Ø©</small> <h2 id="avgAmount">0 Ø±.Ø³</h2> </div>
        </div>

        <table class="report-table">
            <thead>
                <tr>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø­Ù„Ø©</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                    <th>Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚</th>
                    <th>Ø§Ù„Ù…Ø³Ø§Ø±</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                </tr>
            </thead>
            <tbody id="reportContainer">
                </tbody>
        </table>
    </div>

    <script>
        // ØªØ¹ÙŠÙŠÙ† ØªÙˆØ§Ø±ÙŠØ® Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ø£ÙˆÙ„ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ…)
        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('startDate').value = firstDay;
            document.getElementById('endDate').value = today;
            fetchReportData();
        };

        let currentReportData = [];

        async function fetchReportData() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¨ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
            const { data, error } = await _supabase
                .from('trips')
                .select(`
                    created_at, status, price, pickup_address, destination_address,
                    user:user_id ( name ),
                    driver:driver_id ( name )
                `)
                .gte('created_at', start + ' 00:00:00')
                .lte('created_at', end + ' 23:59:59')
                .order('created_at', { ascending: false });

            if (error) return console.error(error);
            
            currentReportData = data;
            renderTable(data);
        }

        function renderTable(data) {
            const container = document.getElementById('reportContainer');
            container.innerHTML = '';
            
            let total = 0;
            let count = 0;

            data.forEach(t => {
                if (t.status === 'completed') {
                    total += t.price;
                    count++;
                }
                
                const date = new Date(t.created_at).toLocaleDateString('ar-SA');
                container.innerHTML += `
                    <tr>
                        <td>${date}</td>
                        <td>${t.user?.name || '---'}</td>
                        <td>${t.driver?.name || '---'}</td>
                        <td><small>${t.pickup_address || ''} â®• ${t.destination_address || ''}</small></td>
                        <td>${t.status}</td>
                        <td style="font-weight:bold">${t.price} Ø±.Ø³</td>
                    </tr>
                `;
            });

            document.getElementById('totalTrips').innerText = data.length;
            document.getElementById('totalAmount').innerText = total + " Ø±.Ø³";
            document.getElementById('avgAmount').innerText = (count > 0 ? (total/count).toFixed(2) : 0) + " Ø±.Ø³";
        }

        function exportToExcel() {
            if (currentReportData.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§ÙƒØ³Ù„
            const excelData = currentReportData.map(t => ({
                "Ø§Ù„ØªØ§Ø±ÙŠØ®": new Date(t.created_at).toLocaleDateString('ar-SA'),
                "Ø§Ù„Ø¹Ù…ÙŠÙ„": t.user?.name,
                "Ø§Ù„Ø³Ø§Ø¦Ù‚": t.driver?.name,
                "Ù…Ù†": t.pickup_address,
                "Ø¥Ù„Ù‰": t.destination_address,
                "Ø§Ù„Ø­Ø§Ù„Ø©": t.status,
                "Ø§Ù„Ù‚ÙŠÙ…Ø©": t.price
            }));

            const worksheet = XLSX.utils.json_to_sheet(excelData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø±Ø­Ù„Ø§Øª");
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
            XLSX.writeFile(workbook, `ØªÙ‚Ø±ÙŠØ±_ØªÙˆØµÙŠÙ„Ùˆ_${new Date().toLocaleDateString()}.xlsx`);
        }
    </script>
</body>
</html>
